name: Setup Node environment
description: >
  Initialize submodules with retry, install Node 22, npm, optionally Bun,
  and run npm install. Requires actions/checkout to run first.
inputs:
  node-version:
    description: Node.js version to install.
    required: false
    default: "22.x"
  install-bun:
    description: Whether to install Bun alongside Node.
    required: false
    default: "true"
  frozen-lockfile:
    description: Whether to use npm ci (true) or npm install (false).
    required: false
    default: "true"
runs:
  using: composite
  steps:
    - name: Checkout submodules (retry)
      shell: bash
      run: |
        set -euo pipefail
        git submodule sync --recursive
        for attempt in 1 2 3 4 5; do
          if git -c protocol.version=2 submodule update --init --force --depth=1 --recursive; then
            exit 0
          fi
          echo "Submodule update failed (attempt $attempt/5). Retryingâ€¦"
          sleep $((attempt * 10))
        done
        exit 1

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ inputs.node-version }}
        check-latest: true
        cache: "npm"

    - name: Setup Bun
      if: inputs.install-bun == 'true'
      uses: oven-sh/setup-bun@v2
      with:
        bun-version: latest

    - name: Runtime versions
      shell: bash
      run: |
        node -v
        npm -v
        if command -v bun &>/dev/null; then bun -v; fi

    - name: Capture node path
      shell: bash
      run: echo "NODE_BIN=$(dirname "$(node -p "process.execPath")")" >> "$GITHUB_ENV"

    - name: Install dependencies
      shell: bash
      env:
        CI: "true"
      run: |
        export PATH="$NODE_BIN:$PATH"
        which node
        node -v
        npm -v
        if [ "${{ inputs.frozen-lockfile }}" = "true" ]; then
          npm ci
        else
          npm install
        fi
